# Automatic Deploy of Content Built from CMS Export Data

**Author(s):** Jhonny Gonzalez, Eugene Doan  
**Last Updated:** January 21, 2021  
**Status:** Draft | **In Review** | Approved  
**Approvers:**
- [ ] Dan Shank
- [ ] Neil Hastings
- [ ] Dror Matalon
- [ ] Michael Fleet

## Overview

### Objective

This document explores an approach to running automatic deploys (auto-deploys) of content built using CMS (content management system) export data.
The approach also considers a feasible frequency for the build and deploy that does not overload the build system.

This document _does not_ discuss the design of the full build and deploy using CMS export data.

The intended audience are front-end (FE) and DevOps engineers on the Veteran-facing Services Platform (VSP) and the CMS teams.

### Background

#### Content build and transformers

The VA.gov website is built from the `vets-website` repo. The build outputs static HTML content, React applications, and styling.

The static content is built through a Metalsmith pipeline using data pulled from the Drupal-based CMS and the [`vagov-content` repo](https://github.com/department-of-veterans-affairs/vagov-content/).

Currently, the data from the Drupal server is fetched with a GraphQL query. However, the GraphQL-based build has limitations in maintainability and scalability, so an alternative is being developed to replace it.

This implementation, the CMS export build, involves the [use of transformers](https://github.com/department-of-veterans-affairs/va.gov-team/tree/master/products/cms-integration) to transform CMS export data generated by [Tome Sync](https://tome.fyi/docs/sub-modules/) into a content model that matches that of the GraphQL data.

In the same manner as the GraphQL data, the transformed CMS export data would then applied to the Liquid templates to generate the HTML files in the build.

#### Deployment

The VA.gov website can be deployed through the partial (or content-only) deploy or the full deploy.

The full deploy is a daily job that deploys `vets-website` to the production environmentt of VA.gov. It uses latest commit of `vets-website` as of 2:00pm ET on that day and the latest content downloaded from the Drupal server. It can be manually invoked as necessary, independently of the daily schedule.

The content-only deploy builds `vets-website` with the latest content downloaded from the Drupal server and deploys to the dev and staging environments of VA.gov. This job can be triggered in one of two ways:
- The daily production deploy of `vets-website`, which will build with latest release of `vets-website`
- The `va-cms-bot`, which will build with the latest commit on `vets-website` in response to a manual trigger on the part of the CMS team

|                     | [Partial Deploy](https://department-of-veterans-affairs.github.io/veteran-facing-services-tools/getting-started/workflow/deploy/#partial-deploy--static-page-changes-only)                                                                                                                                                                                                 | [Full Deploy](https://department-of-veterans-affairs.github.io/veteran-facing-services-tools/getting-started/workflow/deploy/#full-deploy-of-vagov-client-app) |
| ------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Output              | Static pages (.html) only                                                                                                                                                                                                                                                                                                                                                  | Frontend applications (.js, .css) and static pages (.html)                                                                                                     |
| Assets              | Uses the latest `vets-website` release and static asset                                                                                                                                                                                                                                                                                                                    | Creates a new release and deploys it                                                                                                                           |
| Accessibility tests | N/A                                                                                                                                                                                                                                                                                                                                                                        | Runs tests                                                                                                                                                     |
| Links checker       | Runs checks                                                                                                                                                                                                                                                                                                                                                                                                                                          | Runs checks                                                                                                                                                    |

#### Pain points

- Content writers want to quickly draft, publish, and deploy content. However, `vets-website` is only deployed to production once per day.
- The content-only deploy does allow the CMS team to deploy content independently of the daily production deploy, but that is a manual trigger. Furthermore, it does not include automated accessibility checks.
- In local development, engineers can encounter confusing build errors that are due to the mismatch in outdated locally cached content and updated Liquid templates.

### High Level Design

This new auto-deploy has a few main differences with the existing content-only deploy.
- Uses the CMS export to build content
- Runs on a schedule instead of being triggered by other jobs (such as the daily prod deploy)
- Deploys to production instead of only dev and staging

The schedule will run between 8am and 8pm ET. It will initially be set to run hourly as a conservative cadence. It will then be incrementally adjusted to a higher frequency as the build system allows.

To avoid deploying when content hasn't changed since the previous deploy, the job will compare the export data (e.g., using and archiving the checksums of the tarballs).

## Specifics

### Detailed Design

#### Creating a new pipeline

A new pipeline (e.g., `Jenkinsfile.autodeploy`) will be created for the auto-deploy. It will be modeled after the current `Jenkinsfile.content` configuration.

#### Using the CMS export to build content

In order for the partial deploy to use the CMS export data, the [build command](https://github.com/department-of-veterans-affairs/vets-website/blob/master/jenkins/common.groovy#L189) in the `build` function in `jenkins/common.groovy` will have to include the `--use-cms-export` flag.

Keep in mind that this content-only deploy will build using the latest release instead of the latest commit of of `vets-website`. This matches the behavior of the current content-only deploy. The daily production deploy will continue deploying from the latest commit and retain the responsibility of tagging releases.

If this work is done before the full build has transitioned to using the CMS export, the inclusion of the flag will be contingent on the `contentOnly` parameter to the function.

#### Validating the build

The implementation of the full build pipeline may introduce new stages or common helper functions that the auto-deploy pipeline can incorporate. Specifically, the full build pipeline will compare the diffs between GraphQL and CMS export builds. That validation should be done in this pipeline as well while this process is being rolled out.

#### Deploying the build

The pipeline will archive the CMS export build in S3 at a different key than the current GraphQL builds. It should match the location where the full build archives the CMS export builds.

For example, it might be `s3://vetsgov-website-builds-s3-upload/cms-export/${ref}/${envName}.tar.bz2`, where `ref` is the commit hash and `envName` is the environment (one of `vagovdev`, `vagovstaging`, or `vagovprod`).

The subpath `cms-export` in the key will namespace the archived CMS export build separately from the current GraphQL build. This will enable testing and debugging of the new pipeline without intefering with the current deploy process.

#### Scheduling the deploy

The pipeline will [use a cron trigger](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers) to run on the desired schedule.

The schedule to start with will be hourly between 8am and 8pm on weekdays. Ideally, the deploy would run every 5 minutes.

```
node('vagov-autodeploy') {
  triggers {
    cron('0 8-21 * * 1-5')
  }

  dir('vets-website') {
    ...
  }

  stage('Build') {
    ...
  }
}
```

#### Preventing deploys of existing content

On successful deploys, the tarball containing the CMS export data used in the build should be archived in S3. A possible key might be `s3://vetsgov-website-builds-s3-upload/cms-export/data/latest.tar.bz2`.

The CMS export build [currently reads the tarball directly from the response body](https://github.com/department-of-veterans-affairs/vets-website/blob/master/src/site/stages/build/drupal/api.js#L147) and should be modified to save it to a file.

Then on subsequent deploys, the tarball downloaded from Drupal will be compared with the tarball of the previous successful deploy. The build will run only if the MD5 checksums of the two tarballs differ. This ensures that we only run the build when content has changed.

For convenience, we could also upload the checksum to `s3://vetsgov-website-builds-s3-upload/cms-export/data/checksum.txt`. With that, the pipeline would not have to download the full tarball for the comparison.

### Code Location

The pipeline will be defined in `Jenkinsfile.autodeploy`. The [helper functions](https://github.com/department-of-veterans-affairs/vets-website/blob/master/jenkins/common.groovy) that it uses are in `jenkins/common.groovy`.

There may be auxiliary configurations required in the `devops` [repo](https://github.com/department-of-veterans-affairs/devops), likely in the `ansible` directory.

### Testing Plan

The following behaviors should be observed cumulatively as they are implemented.
1. Build is stored at the proper location in S3 when the pipeline is invoked.
2. Pipeline runs on the defined schedule.
3. Deploy doesn't proceed when no new content has been published.

### Logging

On top of the existing build logs, the new content-only deploy will output logs for the new transformation processes in the CMS export build.

### Debugging

The auto-deploy pipeline can be debugged by reading its console output. The S3 bucket can be checked to confirm whether the build has been deployed.

The CMS export build will validate the input and output schemas of the transformers, so errors related to the build itself can be debugged using that output.

As with the full build, during the rollout, there will be a comparison of GraphQL and CMS export builds to report errors when discrepancies between the two are found. The script used for this comparison will have some console output as well as an output JSON file describing the discrepancies.

To determine whether a page exists in the Drupal content, we can go to [`staging.va.gov/drupal/debug/`](staging.va.gov/drupal/debug/). This page is not available in production, however.

### Caveats

To be determined.

### Security Concerns

There are no new security concerns with the auto-deploy. There is no user interaction involved unless we include a manual trigger for use by internal VSP engineers, which still should not present any threat of malicious requests. Denial of service is also not a concern as builds are queued.

### Privacy Concerns

There are no new privacy concerns with the auto-deploy as user data is not involved.

### Open Questions and Risks

#### Questions

- What is the ideal schedule for the auto-deploy?
  - The pipeline will initially run hourly 8am-8pm ET on weekdays.
  - We want the highest rate of deploy that the system can sustain.

- How should we coordinate the schedule of the auto-deploy with the daily production deploy?
  - The deploys from both pipelines will likely overlap.
  - The daily production deploy is still necessary for tagging the release.
  - [The queue of content-only deploys should naturally resolve conflicts without any special handling.](https://github.com/department-of-veterans-affairs/va.gov-team/issues/18393)

- Is there a way to get the time of the last updated published content in Drupal and use that to determine if we should build or not?
  - If we have access to that information, we may not need to compare the CMS export tarballs.

#### Risks

- Newly added content from CMS without associated transformer schemas could fail the build.
  - New content introduces the possibility of new discrepancies, which would fail any validations that depend on diffs between the GraphQL and CMS export builds.
  - Having more content will inflate the runtime of the content-only deploy and could potentially exceed the scheduled interval.
  - The best defense against this is accounting for null and empty fields in transformers.

### Work Estimates

- Create a new content-only deploy job for CMS export builds (5 pts)
- Run the partial deploy on a schedule (3 pts)
- Auto-deploy only new content (3 pts)

### Alternatives

Ideally, content would get deployed immediately as content writers make changes. However, the CMS export process is not suited for multiple invocations in quick succession, so we opted for a process that will essentially batch and deploy content changes as appropriate.

### Future Work

- There are plans to transition from Jenkins to CircleCI for our build pipeline. The auto-deploy job will have to be brought over to CircleCI at that time.
- To improve the runtime, we might want to explore incremental deploys.

### Revision History

| Date         | Revisions Made | Author          |
| ------------ | -------------- | --------------- |
| Jan 21, 2021 | Cleaned up Background. Added info to Alternatives. | Eugene Doan |
| Jan 20, 2021 | Completed first draft | Eugene Doan |
| Dec 10, 2020 | Initial draft  | Jhonny Gonzalez |
